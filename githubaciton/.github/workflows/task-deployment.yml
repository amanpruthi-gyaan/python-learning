name: Task Deployment

on:
  workflow_dispatch:
  push:
    branches:
      - main

  pull_request:
    branches:
      - main


jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout the code
      uses: actions/checkout@v2

    - name: Install kubectl
      uses: daisuke-awaji/setup-kubectl@v1
      with:
        kubectl-version: '1.22.2' 
  
    - name: Read env version of K8s pod
      run: |
        kubectl get pod pods.yaml -o jsonpath='{.metadata.labels.version}'
    
  test:
    needs: build
    runs-on: ubuntu-latest
    if: ${{ needs.build.result == 'failure')

    steps:
    - name: Test
      run: make unit-test


  rollback:
    needs: [build, test]
    runs-on: ubuntu-latest 
    if: ${{ needs.build.result == 'failure' || needs.test.result == 'failure' }} 

    steps:
      - name: Get previous deployment
        uses: peter-evans/get-previous-deployment@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          environment: dev

      - name: Rollback deployment
        uses: peter-evans/rollback@v1
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          deployment_id: ${{ steps.get_previous_deployment.outputs.id }}































      - name: Install Dependencies
        run: |
          python -m pip install --upgrade pip
          python -m pip install -U -r requirements/local.txt

      - name: Check Code Formatting
        run: |
          black --check --config .black.cfg delightiq/ tests/

      - name: Check Linting Errors
        run: |
          export PYTHONPATH=`pwd`
          export DJANGO_SETTINGS_MODULE=base.settings.local

          prospector --profile-path .prospector.yml ./delightiq -A --uses django --uses celery -X
          prospector --profile-path .prospector.yml ./tests -A --uses celery -X

      - name: Run UnitTestcases
        run: |
          export PYTHONPATH=`pwd`
          python delightiq/manage.py collectstatic --noinput
          pytest --cov=delightiq -s tests/unittests

      - name: Run APITestcases
        run: |
          export PYTHONPATH=`pwd`
          pytest --cov=delightiq -s tests/apitests

  build-docker-image:
    name: Build & Push Docker Image
    runs-on: ubuntu-latest
    env:
      ECR_DEV: 788852846271.dkr.ecr.ap-south-1.amazonaws.com
      IMAGE_REPOSITORY: phoenix-repository
      CUBEJS_IMAGE_REPOSITORY: cubejs-repository
      AWS_REGION_DEV: ap-south-1
      AWS_ROLE_DEV: arn:aws:iam::788852846271:role/github-action-role
      ECR_INT: 788852846271.dkr.ecr.us-east-1.amazonaws.com
      AWS_REGION_INT: us-east-1
      AWS_ROLE_INT: arn:aws:iam::788852846271:role/github-action-role
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      #Need to add the below because commits are happening in the ci pipeline
      - run: |
          git pull 
          git checkout HEAD
      ###############release branch event push or manual action ########################

      - name: 'Automated Version Bump'
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/heads/release')  )}}
        uses: 'phips28/gh-action-bump-version@master'
        id: version-bump
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          version-type: 'prerelease'
          tag-prefix: 'v'
          skip-tag: 'true'
          default: prerelease

      - name: 'Output Step'
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/heads/release')  )}}
        env:
          NEW_TAG: ${{ steps.version-bump.outputs.newTag }}
        run: echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV
      
      

      - name: configure aws credentials
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/heads/release')  )}}
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ env.AWS_ROLE_DEV }}
          role-session-name: github-action-role
          aws-region: ${{ env.AWS_REGION_DEV }}

      - name: Login to Amazon Dev ECR
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/heads/release')  )}}
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' && startsWith(github.ref, 'refs/heads/release')  )}}
        id: build-image
        run: |
          env
          # Build a docker container and push it to ECR
          docker build -f delightiq/Dockerfile -t ${{ env.ECR_DEV }}/${{ env.IMAGE_REPOSITORY }}:${{ env.NEW_TAG }} .
          docker push ${{ env.ECR_DEV }}/${{ env.IMAGE_REPOSITORY }}:${{ env.NEW_TAG }}
          # Build a docker container and push it to ECR for cubejs
          docker build -f cubejs/Dockerfile -t ${{ env.ECR_DEV }}/${{ env.CUBEJS_IMAGE_REPOSITORY }}:${{ env.NEW_TAG }} cubejs
          docker push ${{ env.ECR_DEV }}/${{ env.CUBEJS_IMAGE_REPOSITORY }}:${{ env.NEW_TAG }}
 ###############hotfix  branch event push or manual action ########################
      - name: 'Automated Version Bump hotfix'
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  startsWith(github.ref, 'refs/heads/hotfix') )}}
        uses: 'phips28/gh-action-bump-version@master'
        id: version-bump-hotfix
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          version-type: 'patch'
          tag-prefix: 'v'
          skip-tag: 'true'
          default: patch

      - name: 'Output Step'
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  startsWith(github.ref, 'refs/heads/hotfix') )}}
        env:
          NEW_TAG: ${{ steps.version-bump-hotfix.outputs.newTag }}
        run: echo "NEW_TAG=$NEW_TAG" >> $GITHUB_ENV

      - name: configure aws credentials
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  startsWith(github.ref, 'refs/heads/hotfix') )}}
        uses: aws-actions/configure-aws-credentials@v1
        with:
          role-to-assume: ${{ env.AWS_ROLE_INT }}
          role-session-name: github-action-role
          aws-region: ${{ env.AWS_REGION_INT }}

      - name: Login to Amazon Int ECR
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  startsWith(github.ref, 'refs/heads/hotfix') )}}
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push image to Amazon ECR
        if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  startsWith(github.ref, 'refs/heads/hotfix') )}}
        run: |
          env
          # Build a docker container and push it to ECR
          docker build -f delightiq/Dockerfile -t ${{ env.ECR_INT }}/${{ env.IMAGE_REPOSITORY }}:${{ env.NEW_TAG }} .
          docker push ${{ env.ECR_INT }}/${{ env.IMAGE_REPOSITORY }}:${{ env.NEW_TAG }}
          # Build a docker container and push it to ECR for cubejs
          docker build -f cubejs/Dockerfile -t ${{ env.ECR_INT }}/${{ env.CUBEJS_IMAGE_REPOSITORY }}:${{ env.NEW_TAG }} cubejs
          docker push ${{ env.ECR_INT }}/${{ env.CUBEJS_IMAGE_REPOSITORY }}:${{ env.NEW_TAG }}


  deploy_web_dev:
    needs: [ build-docker-image ]
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'dev' )}}    
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: dev
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: ap-south-1
      CLUSTER: phoenix-dev-ap-south-1-cluster
      SERVICE_NAME: web-service


  ###############################################
  # celery-worker-1
  ################################################

  deploy_celery_worker_1_dev:
    needs: [ build-docker-image ]
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'dev' )}}    
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: dev
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: ap-south-1
      CLUSTER: phoenix-dev-ap-south-1-cluster
      SERVICE_NAME: celery-worker-1-service


  ###############################################
  # celery-worker-10
  ################################################

  deploy_celery_worker_10_dev:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'dev' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: dev
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: ap-south-1
      CLUSTER: phoenix-dev-ap-south-1-cluster
      SERVICE_NAME: celery-worker-10-service


  ###############################################
  # celery-worker-100
  ################################################

  deploy_celery_worker_100_dev:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'dev' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: dev
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: ap-south-1
      CLUSTER: phoenix-dev-ap-south-1-cluster
      SERVICE_NAME: celery-worker-100-service


  ###############################################
  # celery-flower
  ################################################

  deploy_celery_flower_dev:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'dev' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: dev
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: ap-south-1
      CLUSTER: phoenix-dev-ap-south-1-cluster
      SERVICE_NAME: celery-flower-service


  ###############################################
  # Celery-beat
  ###############################################

  deploy_celery_beat_dev:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'dev' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: dev
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: ap-south-1
      CLUSTER: phoenix-dev-ap-south-1-cluster
      SERVICE_NAME: celery-beat-service


  ###############################################
  # Jupyter
  ###############################################

  deploy_jupyter_dev:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'dev' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: dev
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: ap-south-1
      CLUSTER: phoenix-dev-ap-south-1-cluster
      SERVICE_NAME: jupyter-service
  ###############################################
  # Cubejs dev 
  ###############################################
  deploy_cubejs_dev:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/release') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'dev' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: dev
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/cubejs-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/cubejs-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: ap-south-1
      CLUSTER: phoenix-dev-ap-south-1-cluster
      SERVICE_NAME: cubejs-service


  deploy_web_int:
    needs: [ build-docker-image ]
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'int' )}}    
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: int
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.us-east-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: us-east-1
      CLUSTER: phoenix-int-us-east-1-cluster
      SERVICE_NAME: web-service


  ###############################################
  # celery-worker-1
  ################################################

  deploy_celery_worker_1_int:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'int' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: int
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.us-east-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: us-east-1
      CLUSTER: phoenix-int-us-east-1-cluster
      SERVICE_NAME: celery-worker-1-service


  ###############################################
  # celery-worker-10
  ################################################

  deploy_celery_worker_10_int:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'int' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: int
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.us-east-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: us-east-1
      CLUSTER: phoenix-int-us-east-1-cluster
      SERVICE_NAME: celery-worker-10-service


  ###############################################
  # celery-worker-100
  ################################################

  deploy_celery_worker_100_int:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'int' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: int
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.us-east-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: us-east-1
      CLUSTER: phoenix-int-us-east-1-cluster
      SERVICE_NAME: celery-worker-100-service


  ###############################################
  # celery-flower
  ################################################

  deploy_celery_flower_int:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'int' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: int
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.us-east-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: us-east-1
      CLUSTER: phoenix-int-us-east-1-cluster
      SERVICE_NAME: celery-flower-service


  ###############################################
  # Celery-beat
  ###############################################

  deploy_celery_beat_int:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'int' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: int
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.us-east-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: us-east-1
      CLUSTER: phoenix-int-us-east-1-cluster
      SERVICE_NAME: celery-beat-service


  ###############################################
  # Jupyter
  ###############################################

  deploy_jupyter_int:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'int' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: int
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/phoenix-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.us-east-1.amazonaws.com/phoenix-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: us-east-1
      CLUSTER: phoenix-int-us-east-1-cluster
      SERVICE_NAME: jupyter-service
  ###############################################
  # Cubejs dev 
  ###############################################
  deploy_cubejs_int:
    if: ${{ (github.event_name == 'push' && startsWith(github.ref, 'refs/heads/hotfix') ) || (github.event_name == 'workflow_dispatch' &&  github.event.inputs.environment   == 'int' )}}    
    needs: [ build-docker-image ]
    uses: ./.github/workflows/reusable-deployment-workflow.yml
    with:
      ENV: int
      AWS_REGION: ap-south-1
      SOURCE_IMAGE_REPO: 788852846271.dkr.ecr.ap-south-1.amazonaws.com/cubejs-repository
      TARGET_IMAGE_REPO: 788852846271.dkr.ecr.us-east-1.amazonaws.com/cubejs-repository
      AWS_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_ROLE: arn:aws:iam::788852846271:role/github-action-role
      AWS_TARGET_REGION: us-east-1
      CLUSTER: phoenix-int-us-east-1-cluster
      SERVICE_NAME: cubejs-service
      